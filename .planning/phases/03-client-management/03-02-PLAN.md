---
phase: 03-client-management
plan: 2
type: execute
---

<objective>
Build frontend UI for client management and implement secure file download system.

Purpose: Enable users to create, view, and download VPN client configurations through intuitive web interface with secure one-time download links.
Output: Client management dashboard, create/delete forms, download endpoint with session validation, updated installer deployment.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plan context:**
@.planning/phases/03-client-management/03-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Session timeout: 1-hour (from Phase 2)
- Port 8443 for HTTPS portal
- Responsive modern UI with gradient design (established in Phase 2 templates)
- File permissions: 600 for sensitive files

**Requirements from PROJECT.md:**
- One-time download links for client files (regenerate if session valid)
- Platform-agnostic client configs (already implemented in Phase 1)
- Simple "login and download" UX
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client management dashboard template</name>
  <files>install.sh</files>
  <action>
Replace the existing placeholder dashboard.html in create_flask_app() function (around line 720-740) with full client management UI:

Structure:
- Header with logout button (keep existing)
- Server info section (keep existing IP display)
- Client list section:
  - Table showing client names, file sizes, actions (download, delete)
  - "No clients yet" message if list empty
  - Each row: client name, file size (formatted KB/MB), Download button, Delete button (with confirmation)
- Create client section:
  - Form with client name input (pattern validation: [a-zA-Z0-9_-]+)
  - Submit button "Create Client"
  - Real-time validation feedback

Use async JavaScript fetch() to call /api/clients/list on page load and populate table.
Use fetch() for create/delete actions with JSON responses.
Show success/error messages using simple alert() or div.innerHTML (keep it simple, no complex toast libraries).

Style: Match existing gradient design from login.html (modern, responsive, clean).
  </action>
  <verify>
Grep for "client-list\|create-client-form" in install.sh shows new HTML structure.
Check that JavaScript fetch() calls are present for API integration.
Verify form includes pattern validation attribute.
  </verify>
  <done>
dashboard.html replaced with full client management UI including list table, create form, and delete actions with JavaScript API integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement secure file download endpoint</name>
  <files>install.sh</files>
  <action>
Add Flask route for file downloads in create_flask_app() after the API routes:

- GET /download/&lt;client_name&gt; - Protected by @login_required
  - Validate client_name matches regex [a-zA-Z0-9_-]+
  - Check if file exists: /root/openvpn-clients/{client_name}.ovpn
  - Return 404 if file doesn't exist
  - Use Flask send_file() to serve the file
  - Set proper headers: Content-Type: application/x-openvpn-profile, Content-Disposition: attachment; filename={client_name}.ovpn
  - File served directly from disk, no copying needed

Security considerations:
- @login_required ensures session validation (1-hour timeout from Phase 2)
- Path traversal prevention: validate client_name before constructing path
- Do NOT allow arbitrary paths - only files matching CLIENT_DIR/{validated_name}.ovpn
- Example validation: if not re.match(r'^[a-zA-Z0-9_-]+$', client_name): abort(400)

Note: "One-time download links" requirement interpreted as session-protected downloads (download allowed while logged in). No separate token system needed - session auth is sufficient.
  </action>
  <verify>
Grep for "def download\|send_file" in install.sh shows new route.
Check that @login_required decorator is present.
Verify regex validation before file path construction.
Check that send_file uses proper headers.
  </verify>
  <done>
Secure download endpoint implemented with session validation, path traversal prevention, and proper MIME type headers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update installer to deploy new portal code</name>
  <files>install.sh</files>
  <action>
Verify that create_flask_app() function deploys the complete Flask app.py to /opt/openvpn-portal/app.py during installation.

Ensure the function:
1. Creates /opt/openvpn-portal/ directory structure
2. Writes complete app.py with all imports at top:
   - flask (Flask, render_template, request, session, redirect, url_for, jsonify, send_file, abort)
   - werkzeug.security (check_password_hash)
   - subprocess, os, re, json, pathlib
3. Includes all routes: /, /login, /dashboard, /logout, /api/clients/*, /download/*
4. SSL context configuration with self-signed certs
5. Secret key generation
6. Proper error handling

Test that installer completes without syntax errors (bash -n install.sh should pass).
  </action>
  <verify>
bash -n install.sh returns 0 (syntax check passes).
Grep for "from flask import.*send_file" shows send_file in imports.
Check that all new routes are included in app.py template.
  </verify>
  <done>
Installer deploys complete Flask application with all routes, imports, and configuration. Syntax validation passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete client management system with web UI, backend API, and secure downloads</what-built>
  <how-to-verify>
Full integration test of client lifecycle:

1. Run the installer:
   - If testing on clean VM: sudo bash install.sh
   - If testing updates: Update install.sh locally and run

2. Access the portal:
   - Visit https://&lt;server-ip&gt;:8443 (accept self-signed cert warning)
   - Login with credentials from installer output

3. Test client creation:
   - Enter client name "test-client-1" in create form
   - Click "Create Client"
   - Verify success message appears
   - Verify client appears in client list table

4. Test client download:
   - Click "Download" button for test-client-1
   - Verify .ovpn file downloads with correct name
   - Open file in text editor - verify it contains &lt;ca&gt;, &lt;cert&gt;, &lt;key&gt;, &lt;tls-crypt&gt; sections

5. Test client deletion:
   - Click "Delete" button for test-client-1
   - Confirm deletion in dialog
   - Verify client removed from list
   - Verify "No clients yet" message appears

6. Test validation:
   - Try creating client with invalid name "test@client" - should show error
   - Try creating client with valid name - should succeed

7. Check OpenVPN server:
   - SSH to server: sudo systemctl status openvpn-server@server
   - Verify service is running
   - Check CRL exists: ls -la /etc/openvpn/server/crl.pem
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Client management dashboard displays and functions
- [ ] Client creation works with validation
- [ ] Client download endpoint serves .ovpn files correctly
- [ ] Client deletion removes files and revokes certificates
- [ ] No JavaScript errors in browser console
- [ ] OpenVPN server continues running after client operations
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Full client lifecycle functional (create → download → delete)
- Phase 3 complete - ready for Phase 4
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-management/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Frontend & Downloads Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `install.sh` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 3 complete. Client management system fully functional with:
- ✓ Web UI for client operations
- ✓ Backend API integrated with OpenVPN
- ✓ Secure file downloads
- ✓ Certificate lifecycle management

Ready for Phase 4: Testing & Polish (cross-platform validation, production readiness).
</output>
