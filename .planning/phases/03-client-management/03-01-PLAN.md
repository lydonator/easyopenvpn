---
phase: 03-client-management
plan: 1
type: execute
---

<objective>
Build backend infrastructure for OpenVPN client lifecycle management through Flask API.

Purpose: Enable programmatic client creation, listing, and deletion through web portal backend, integrating with existing OpenVPN certificate infrastructure.
Output: Flask routes for client CRUD operations, bash utilities for certificate management, client listing functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summaries:**
@.planning/phases/01-installer-openvpn-setup/01-04-SUMMARY.md
@.planning/phases/02-web-portal-foundation/02-02-SUMMARY.md

**Prior decisions affecting this phase:**
- Inline certificate format established in Phase 1 (single .ovpn file with embedded certs)
- Client name validation: alphanumeric with dashes/underscores only
- Client directory: /root/openvpn-clients/
- Flask app structure: /opt/openvpn-portal/app.py with session-based auth

**Existing implementation to integrate with:**
@install.sh (lines 507-601: generate_client_cert() and create_client_ovpn() functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Flask routes for client operations</name>
  <files>install.sh</files>
  <action>
In the create_flask_app() function around line 650-750, add Flask routes for client management after the existing dashboard/logout routes:

- POST /api/clients/create - Accepts client_name parameter, validates format, calls generate_client_cert() and create_client_ovpn() via subprocess, returns JSON success/error
- GET /api/clients/list - Lists all .ovpn files in CLIENT_DIR, returns JSON array with client names and file sizes
- POST /api/clients/delete - Accepts client_name parameter, calls new delete_client() bash function, returns JSON success/error

Use subprocess.run() to call bash functions from Flask. Ensure all routes are protected by @login_required decorator. Return proper HTTP status codes (200, 400, 500).

IMPORTANT: Do NOT use shell=True in subprocess calls - pass command as list to avoid injection vulnerabilities.
  </action>
  <verify>
Grep for "def create_client\|def list_clients\|def delete_client" in install.sh shows new Flask routes.
Check that @login_required decorator is present on all routes.
Check that subprocess.run calls use list format, not shell=True.
  </verify>
  <done>
Three Flask API routes added: /api/clients/create, /api/clients/list, /api/clients/delete with proper auth and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client deletion bash function</name>
  <files>install.sh</files>
  <action>
Add delete_client() bash function after create_client_ovpn() around line 602:

Function should:
1. Accept CLIENT_NAME as parameter
2. Validate client name matches regex (reuse validation from generate_client_cert)
3. Revoke client certificate: cd $EASYRSA_DIR && ./easyrsa revoke $CLIENT_NAME && ./easyrsa gen-crl
4. Copy updated CRL to OpenVPN directory: cp pki/crl.pem $OPENVPN_DIR/crl.pem
5. Remove client files: rm -f $CLIENT_DIR/${CLIENT_NAME}.ovpn
6. Remove cert files: rm -f $EASYRSA_DIR/pki/issued/${CLIENT_NAME}.crt $EASYRSA_DIR/pki/private/${CLIENT_NAME}.key
7. Restart OpenVPN service to reload CRL: systemctl restart openvpn-server@server
8. Return 0 on success, 1 on error with error_exit

Add CRL configuration to OpenVPN server config during setup_openvpn_server() if not already present: "crl-verify /etc/openvpn/server/crl.pem"
  </action>
  <verify>
Grep for "delete_client()" in install.sh shows new function.
Check that CRL revocation commands are present.
Verify systemctl restart command is included.
Check that OpenVPN server config includes crl-verify directive.
  </verify>
  <done>
delete_client() function implemented with certificate revocation, file cleanup, and service restart. CRL verification enabled in OpenVPN config.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add client listing utility function</name>
  <files>install.sh</files>
  <action>
Add list_clients() bash function after delete_client():

Function should:
1. Check if CLIENT_DIR exists, create if missing
2. Find all .ovpn files in CLIENT_DIR
3. For each file, output JSON line: {"name": "client1", "file": "/root/openvpn-clients/client1.ovpn", "size": 12345}
4. Use jq or pure bash to format JSON (prefer pure bash to avoid dependency)
5. Return 0 on success

Example pure bash JSON output:
```bash
for ovpn in "$CLIENT_DIR"/*.ovpn; do
    [[ -f "$ovpn" ]] || continue
    basename="${ovpn##*/}"
    name="${basename%.ovpn}"
    size=$(stat -f%z "$ovpn" 2>/dev/null || stat -c%s "$ovpn")
    echo "{\"name\":\"$name\",\"file\":\"$ovpn\",\"size\":$size}"
done
```

Note: Use stat -c%s for Linux (Debian/Ubuntu), stat -f%z for BSD/macOS. Installer targets Ubuntu/Debian so use -c%s.
  </action>
  <verify>
Grep for "list_clients()" in install.sh shows new function.
Check that function outputs JSON format.
Verify it handles empty client directory gracefully.
  </verify>
  <done>
list_clients() function outputs JSON array of client names, files, and sizes. Handles empty directory case.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All three bash functions exist: delete_client(), list_clients()
- [ ] All three Flask routes exist with @login_required decorator
- [ ] subprocess.run() calls use list format (not shell=True)
- [ ] CRL verification enabled in OpenVPN server config
- [ ] No shell injection vulnerabilities introduced
</verification>

<success_criteria>
- All tasks completed
- Backend API routes functional for client CRUD
- Bash integration layer complete
- No security vulnerabilities (injection, auth bypass)
- Code builds without syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-management/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Backend Client Management Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `install.sh` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-02-PLAN.md (Frontend & Downloads)
</output>
