---
phase: 01-installer-openvpn-setup
plan: 01
type: execute
---

<objective>
Create installer framework with package installation and public IP detection.

Purpose: Establish the foundation bash script that handles OS detection, error handling, package installation, and network configuration - the core infrastructure all subsequent plans depend on.
Output: Working install.sh script that installs OpenVPN/Easy-RSA and detects the server's public IP.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-installer-openvpn-setup/DISCOVERY.md

**Core requirement:** Installation must be "curl | bash" with zero manual intervention. If the installer requires any user input or manual steps, it violates the project's core value.

**From discovery:**
- Use single-file bash installer (industry standard for curl|bash)
- Explicit error handling with `set -o pipefail`, NOT `set -e`
- Idempotent design (safe to re-run)
- OS detection via /etc/os-release
- Public IP via DNS (dig + OpenDNS) with HTTP fallback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create installer script structure</name>
  <files>install.sh</files>
  <action>Create install.sh with:

**Header:**
- Shebang #!/bin/bash
- Description: "EasyOpenVPN installer - curl | bash OpenVPN server setup"
- Usage instructions (for those who read before executing)

**Error handling setup:**
- `set -o pipefail` (catch pipeline failures)
- Do NOT use `set -e` (unreliable, causes unpredictable exits - discovery shows experienced devs avoid it)
- Create error_exit() function: `error_exit() { echo "Error: $1" >&2; exit "${2:-1}"; }`
- Create cleanup() trap for temp file removal

**OS detection:**
- Source /etc/os-release
- Check $ID is "ubuntu" or "debian"
- Store $VERSION_ID for later use
- Exit with clear error if unsupported OS

**Root check:**
- Verify EUID=0
- Exit with "Must run as root" if not

**Idempotency check:**
- Check if `systemctl is-active --quiet openvpn-server@server`
- If already running, display message and exit gracefully
- Store result in IS_INSTALLED variable for later plans

**Variable declarations section:**
- OPENVPN_DIR="/etc/openvpn/server"
- EASYRSA_DIR="/etc/openvpn/easy-rsa"
- CLIENT_DIR="/root/openvpn-clients"
- LOG_FILE="/var/log/openvpn-install.log"

Use explicit error checking (|| error_exit "message") for all critical operations. Keep functions modular for clarity.</action>
  <verify>bash -n install.sh returns 0 (syntax check), script contains error_exit function, contains OS detection block, contains root check</verify>
  <done>install.sh exists, passes shellcheck (or bash -n if shellcheck not available), has complete error handling framework, OS and root checks present</done>
</task>

<task type="auto">
  <name>Task 2: Install OpenVPN and Easy-RSA packages</name>
  <files>install.sh</files>
  <action>Add package installation logic to install.sh:

**Function: install_packages()**

1. **Update package lists:**
   ```
   apt-get update || error_exit "Failed to update package lists"
   ```

2. **Check if already installed (idempotency):**
   ```
   if dpkg -s openvpn &>/dev/null && dpkg -s easy-rsa &>/dev/null; then
     echo "Packages already installed, skipping"
     return 0
   fi
   ```

3. **Install packages:**
   ```
   apt-get install -y openvpn easy-rsa || error_exit "Failed to install packages"
   ```

4. **Verify installation:**
   ```
   command -v openvpn >/dev/null || error_exit "OpenVPN not found after installation"
   ```

5. **Check Easy-RSA location:**
   Easy-RSA may be in /usr/share/easy-rsa/ - verify path and store in EASYRSA_PKG_DIR variable

**Log progress:**
Echo "Installing OpenVPN and Easy-RSA..." before operation
Echo "✓ Packages installed successfully" after

**Why not raw OpenSSL:** Easy-RSA is purpose-built for OpenVPN PKI management with simplified workflow and active maintenance (discovery recommendation).</action>
  <verify>Run install.sh on Ubuntu/Debian VM, check dpkg -l shows openvpn and easy-rsa installed, /usr/share/easy-rsa exists</verify>
  <done>Packages install successfully, script exits gracefully if already installed, error messages clear if installation fails</done>
</task>

<task type="auto">
  <name>Task 3: Detect server public IP address</name>
  <files>install.sh</files>
  <action>Add IP detection logic to install.sh:

**Function: detect_public_ip()**

1. **Primary method - DNS-based (most reliable per discovery):**
   ```
   PUBLIC_IP=$(dig +short myip.opendns.com @resolver1.opendns.com 2>/dev/null)
   ```

2. **If dig fails, try HTTP fallback:**
   ```
   if [[ -z "$PUBLIC_IP" ]]; then
     PUBLIC_IP=$(curl -s --max-time 5 ifconfig.me 2>/dev/null)
   fi
   ```

3. **If both fail, try second HTTP fallback:**
   ```
   if [[ -z "$PUBLIC_IP" ]]; then
     PUBLIC_IP=$(curl -s --max-time 5 icanhazip.com 2>/dev/null)
   fi
   ```

4. **If all methods fail:**
   ```
   if [[ -z "$PUBLIC_IP" ]]; then
     error_exit "Could not detect public IP address. Please check network connectivity."
   fi
   ```

5. **Validate IP format:**
   ```
   if ! [[ "$PUBLIC_IP" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
     error_exit "Detected IP '$PUBLIC_IP' is not valid IPv4 format"
   fi
   ```

6. **Store in variable:**
   Export PUBLIC_IP for use in later configuration

**Log progress:**
Echo "Detecting public IP address..." before operation
Echo "✓ Detected public IP: $PUBLIC_IP" after

**Why DNS first:** Discovery shows DNS-based detection (via OpenDNS) is more reliable than HTTP services that can shut down or change format.</action>
  <verify>Run detect_public_ip() function, verify it returns valid IPv4 address, test with dig unavailable (should fall back to curl)</verify>
  <done>Function successfully detects public IP via primary or fallback methods, validates IP format, fails gracefully with clear error if all methods unavailable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] install.sh exists and is executable (chmod +x)
- [ ] bash -n install.sh passes (syntax valid)
- [ ] Script contains all three functions: error handling, package installation, IP detection
- [ ] Running script on clean Ubuntu/Debian system installs packages successfully
- [ ] PUBLIC_IP variable contains valid IPv4 address after execution
- [ ] Script is idempotent (running twice doesn't fail or duplicate work)
</verification>

<success_criteria>
- All tasks completed
- install.sh framework established with proper error handling
- OpenVPN and Easy-RSA packages installed
- Public IP detected and validated
- Script runs successfully on Ubuntu 22.04/24.04 and Debian 11/12
- No errors or warnings during execution
</success_criteria>

<output>
After completion, create `.planning/phases/01-installer-openvpn-setup/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Installer Framework & Package Setup Summary

**[One-liner describing what shipped]**

## Accomplishments

- Installer framework with error handling and OS detection
- OpenVPN and Easy-RSA package installation
- Public IP detection with DNS and HTTP fallbacks

## Files Created/Modified

- `install.sh` - Main installer script with framework and package setup

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 01-02-PLAN.md (Certificate Generation)
</output>
