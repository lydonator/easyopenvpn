---
phase: 01-installer-openvpn-setup
plan: 04
type: execute
---

<objective>
Generate first client certificate and create downloadable inline .ovpn configuration file.

Purpose: Complete the installer by generating a working client config file that users can immediately download and use to connect to their VPN.
Output: Client certificate generated and client.ovpn file with all certificates embedded inline, ready for distribution.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-installer-openvpn-setup/DISCOVERY.md
@.planning/phases/01-installer-openvpn-setup/01-01-SUMMARY.md
@.planning/phases/01-installer-openvpn-setup/01-02-SUMMARY.md
@.planning/phases/01-installer-openvpn-setup/01-03-SUMMARY.md

**Dependencies:** Requires Easy-RSA PKI from Plan 2, PUBLIC_IP from Plan 1, running server from Plan 3.

**Core requirement:** Client must download a single .ovpn file that works immediately with no additional configuration (project core value).

**From discovery:**
- Generate client cert via Easy-RSA build-client-full
- Create inline .ovpn file with embedded certificates (not separate files)
- Include remote directive with PUBLIC_IP
- Must use unique common name per client (critical security requirement)
- Store in /root/openvpn-clients/ directory
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate first client certificate</name>
  <files>install.sh</files>
  <action>Add client certificate generation logic to install.sh:

**Function: generate_client_cert()**

Parameters: CLIENT_NAME (default "client1" for first client)

1. **Validate client name:**
   ```
   CLIENT_NAME="${1:-client1}"

   # Ensure client name is alphanumeric with dashes/underscores only
   if ! [[ "$CLIENT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
     error_exit "Invalid client name. Use only letters, numbers, dashes, and underscores."
   fi
   ```

2. **Check if client already exists (idempotency):**
   ```
   cd "$EASYRSA_DIR" || error_exit "Failed to change to Easy-RSA directory"

   if [[ -f "pki/issued/${CLIENT_NAME}.crt" ]]; then
     echo "Client certificate for '$CLIENT_NAME' already exists, skipping generation"
     return 0
   fi
   ```

3. **Generate client certificate and key:**
   ```
   EASYRSA_BATCH=1 ./easyrsa build-client-full "$CLIENT_NAME" nopass || error_exit "Failed to generate client certificate for $CLIENT_NAME"
   ```

4. **Verify client certificate created:**
   ```
   [[ -f "pki/issued/${CLIENT_NAME}.crt" ]] || error_exit "Client certificate not found after generation"
   [[ -f "pki/private/${CLIENT_NAME}.key" ]] || error_exit "Client private key not found after generation"
   ```

5. **Create client config directory:**
   ```
   mkdir -p "$CLIENT_DIR" || error_exit "Failed to create client directory"
   ```

**Log progress:**
Echo "Generating client certificate for '$CLIENT_NAME'..." before operation
Echo "✓ Client certificate generated" after

**Why unique common name critical:** OpenVPN identifies clients by certificate CN. Duplicate CNs cause connection conflicts and security issues (discovery warning).</action>
  <verify>After running, check pki/issued/client1.crt and pki/private/client1.key exist, openssl x509 can parse certificate</verify>
  <done>Client certificate and key generated successfully, files exist in Easy-RSA PKI directory</done>
</task>

<task type="auto">
  <name>Task 2: Create inline client .ovpn configuration file</name>
  <files>install.sh</files>
  <action>Add client config generation logic to install.sh:

**Function: create_client_ovpn()**

Parameters: CLIENT_NAME (default "client1")

1. **Set client name:**
   ```
   CLIENT_NAME="${1:-client1}"
   OVPN_FILE="$CLIENT_DIR/${CLIENT_NAME}.ovpn"
   ```

2. **Create base client configuration:**
   ```
   cat > "$OVPN_FILE" <<EOF
# EasyOpenVPN client configuration for $CLIENT_NAME
client
dev tun
proto udp
remote $PUBLIC_IP 1194

# Security
cipher AES-128-GCM
auth SHA256
tls-version-min 1.2

# Connection
resolv-retry infinite
nobind
persist-key
persist-tun

# Logging
verb 3
mute 20
EOF
   ```

3. **Append inline CA certificate:**
   ```
   echo "<ca>" >> "$OVPN_FILE"
   cat "$OPENVPN_DIR/ca.crt" >> "$OVPN_FILE"
   echo "</ca>" >> "$OVPN_FILE"
   ```

4. **Append inline client certificate:**
   ```
   echo "<cert>" >> "$OVPN_FILE"
   # Extract certificate part only (skip bag attributes and key)
   openssl x509 -in "$EASYRSA_DIR/pki/issued/${CLIENT_NAME}.crt" >> "$OVPN_FILE" || error_exit "Failed to extract client certificate"
   echo "</cert>" >> "$OVPN_FILE"
   ```

5. **Append inline client private key:**
   ```
   echo "<key>" >> "$OVPN_FILE"
   cat "$EASYRSA_DIR/pki/private/${CLIENT_NAME}.key" >> "$OVPN_FILE"
   echo "</key>" >> "$OVPN_FILE"
   ```

6. **Append inline tls-crypt key:**
   ```
   echo "<tls-crypt>" >> "$OVPN_FILE"
   cat "$OPENVPN_DIR/tc.key" >> "$OVPN_FILE"
   echo "</tls-crypt>" >> "$OVPN_FILE"
   ```

7. **Set file permissions:**
   ```
   chmod 600 "$OVPN_FILE" || error_exit "Failed to set permissions on client config"
   ```

8. **Verify config file created:**
   ```
   [[ -f "$OVPN_FILE" ]] || error_exit "Client config file not created"
   ```

**Log progress:**
Echo "Creating client configuration file..." before operation
Echo "✓ Client configuration created: $OVPN_FILE" after
Echo "Download this file and import it into your OpenVPN client"

**Why inline format:** Single-file distribution is simpler for users - no managing separate .crt and .key files (discovery recommendation for zero-touch UX).
**Why openssl x509 extraction:** Easy-RSA output includes metadata that breaks inline format - must extract cert portion only.</action>
  <verify>After running, check client.ovpn exists, contains "remote $PUBLIC_IP 1194", contains <ca>, <cert>, <key>, <tls-crypt> sections with content</verify>
  <done>Inline .ovpn file created with all certificates embedded, file has correct permissions (600), ready for client distribution</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Client certificate generated in Easy-RSA PKI
- [ ] client.ovpn file exists in /root/openvpn-clients/
- [ ] .ovpn file contains remote directive with PUBLIC_IP
- [ ] .ovpn file contains inline <ca>, <cert>, <key>, <tls-crypt> sections
- [ ] All inline sections have actual certificate/key content (not empty)
- [ ] File permissions are 600 (read/write for root only)
- [ ] installer completes successfully and displays next steps
</verification>

<success_criteria>
- All tasks completed
- First client certificate generated successfully
- Inline .ovpn configuration file created with all certificates embedded
- File ready for download and immediate use by client
- Installer displays clear instructions for next steps
- Phase 1 complete: working OpenVPN server with first client config
</success_criteria>

<output>
After completion, create `.planning/phases/01-installer-openvpn-setup/01-04-SUMMARY.md`:

# Phase 1 Plan 4: Client Config Generation Summary

**[One-liner describing what shipped]**

## Accomplishments

- First client certificate generated (client1)
- Inline .ovpn configuration file created
- All certificates embedded in single file
- Installer complete and functional

## Files Created/Modified

- `install.sh` - Added client certificate and config generation functions
- `/etc/openvpn/easy-rsa/pki/issued/client1.crt` - Client certificate
- `/etc/openvpn/easy-rsa/pki/private/client1.key` - Client private key
- `/root/openvpn-clients/client1.ovpn` - Client configuration file

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 1 complete. Ready for Phase 2: Web Portal Foundation

**Install.sh completion message should include:**
```
====================================
OpenVPN Installation Complete!
====================================

Server is running on: $PUBLIC_IP:1194

Client configuration: /root/openvpn-clients/client1.ovpn

Download this file and import it into your OpenVPN client:
- Windows/Mac/Linux: OpenVPN GUI or OpenVPN Connect
- iOS/Android: OpenVPN Connect app

To create additional clients, re-run this installer
(future: will be handled via web portal)

====================================
```
</output>
