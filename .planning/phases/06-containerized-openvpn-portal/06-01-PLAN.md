---
phase: 06-containerized-openvpn-portal
plan: 1
type: execute
---

<objective>
Create OpenVPN container structure with Dockerfile and initialization logic.

Purpose: Build the OpenVPN server container that handles PKI generation and VPN server configuration, replacing host-based installation.
Output: openvpn/Dockerfile and openvpn/docker-entrypoint.sh that produce a working OpenVPN server container.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-docker-prerequisites-host-setup/DISCOVERY.md
@.planning/phases/06-containerized-openvpn-portal/DISCOVERY.md
@.planning/phases/05-docker-prerequisites-host-setup/05-02-SUMMARY.md

**Key decisions from prior phases:**
- Phase 5 completed Docker/Compose installation and host networking setup
- Using Docker convenience script (get.docker.com) for installation
- Bridge networking with port mapping (not host mode)
- TUN module loaded and persistent

**Discovery findings:**
- Use debian:bookworm-slim base image (smaller, apt-based, stable)
- Two-container architecture (OpenVPN + Portal separate)
- Named volumes for PKI persistence
- Container capabilities: NET_ADMIN, MKNOD, /dev/net/tun device
- Entrypoint handles PKI initialization on first run (idempotent)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenVPN Dockerfile</name>
  <files>openvpn/Dockerfile</files>
  <action>
Create openvpn/Dockerfile with the following structure:
- Base image: debian:bookworm-slim
- Install packages: openvpn, easy-rsa, iptables (clean up apt lists after)
- Create directories: /etc/openvpn/server, /etc/openvpn/easy-rsa
- Copy docker-entrypoint.sh to /usr/local/bin/ and make executable
- Expose 1194/udp
- Add health check: pgrep -x openvpn (30s interval, 5s timeout, 10s start period)
- ENTRYPOINT ["docker-entrypoint.sh"]
- CMD ["openvpn", "--config", "/etc/openvpn/server/server.conf"]

Keep Dockerfile simple and focused. Don't add unnecessary packages or complexity.
  </action>
  <verify>
- openvpn/Dockerfile exists
- Contains FROM debian:bookworm-slim
- Contains all required RUN, COPY, EXPOSE, HEALTHCHECK, ENTRYPOINT, CMD directives
- No syntax errors (docker build --no-cache -t test-openvpn openvpn/ succeeds with warnings OK)
  </verify>
  <done>Dockerfile created with correct structure, builds without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create docker-entrypoint.sh with PKI initialization</name>
  <files>openvpn/docker-entrypoint.sh</files>
  <action>
Create openvpn/docker-entrypoint.sh that handles:

1. First-run detection: Check if /etc/openvpn/easy-rsa/pki/ca.crt exists
2. If first run (PKI missing):
   - Initialize Easy-RSA: easyrsa init-pki
   - Build CA (non-interactive): easyrsa --batch build-ca nopass
   - Generate server cert: easyrsa --batch build-server-full server nopass
   - Generate DH parameters: easyrsa gen-dh
   - Generate TLS auth key: openvpn --genkey secret /etc/openvpn/server/ta.key
3. Generate /etc/openvpn/server/server.conf using environment variables:
   - port ${VPN_PORT:-1194}
   - proto ${VPN_PROTOCOL:-udp}
   - dev tun
   - ca, cert, key, dh paths (from PKI)
   - server ${VPN_SUBNET:-10.8.0.0} ${VPN_NETMASK:-255.255.255.0}
   - push "redirect-gateway def1 bypass-dhcp"
   - push "dhcp-option DNS ${DNS_SERVER:-8.8.8.8}"
   - keepalive 10 120
   - cipher AES-256-GCM
   - auth SHA256
   - user nobody, group nogroup (after init)
   - persist-key, persist-tun
   - status /var/log/openvpn/status.log
   - verb 3
4. Enable IP forwarding: sysctl -w net.ipv4.ip_forward=1
5. Set up iptables NAT for VPN subnet: iptables -t nat -A POSTROUTING -s ${VPN_SUBNET}/24 -o eth0 -j MASQUERADE
6. Execute CMD: exec "$@" (starts openvpn daemon)

Make script idempotent - if PKI exists, skip initialization and start OpenVPN directly.
Use #!/bin/bash shebang. Add error handling (set -e). Add echo statements showing progress.
  </action>
  <verify>
- openvpn/docker-entrypoint.sh exists
- Has #!/bin/bash shebang and set -e
- Contains PKI detection logic (checks ca.crt)
- Contains Easy-RSA initialization commands
- Generates server.conf with environment variable substitution
- Contains iptables NAT setup
- Ends with exec "$@"
- Is executable (chmod +x)
  </verify>
  <done>Entrypoint script created with complete PKI initialization and OpenVPN startup logic</done>
</task>

<task type="auto">
  <name>Task 3: Test OpenVPN container builds and structure</name>
  <files>None (verification only)</files>
  <action>
Build the OpenVPN container locally to verify it works:
1. Run: docker build --no-cache -t easyopenvpn-server:test openvpn/
2. Verify build succeeds (warnings OK, errors NOT OK)
3. Inspect image: docker images | grep easyopenvpn-server
4. Check entrypoint is set: docker inspect easyopenvpn-server:test | grep -A5 Entrypoint

Don't actually run the container yet (Phase 6 Plan 3 will handle orchestration).
Just verify the build process works.
  </action>
  <verify>
- docker build command succeeds
- Image easyopenvpn-server:test exists in docker images output
- docker inspect shows Entrypoint includes docker-entrypoint.sh
- No build errors in output
  </verify>
  <done>OpenVPN container builds successfully, entrypoint configured correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] openvpn/Dockerfile exists and follows debian:bookworm-slim pattern
- [ ] openvpn/docker-entrypoint.sh exists and is executable
- [ ] docker build succeeds without errors
- [ ] Image contains openvpn, easy-rsa, iptables packages
- [ ] Entrypoint is properly configured in image
</verification>

<success_criteria>
- All tasks completed
- OpenVPN container structure created
- Container builds successfully
- Ready for integration with docker-compose.yml (Plan 3)
</success_criteria>

<output>
After completion, create `.planning/phases/06-containerized-openvpn-portal/06-01-SUMMARY.md`:

# Phase 6 Plan 1: OpenVPN Container Structure Summary

**[One-liner describing what was built]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `openvpn/Dockerfile` - Description
- `openvpn/docker-entrypoint.sh` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 06-02-PLAN.md (Flask Portal Container Structure)
</output>
