---
phase: 05-docker-prerequisites-host-setup
plan: 2
type: execute
---

<objective>
Configure host networking for containerized services and simplify installer by removing v1.0 host-based idempotency logic.

Purpose: Enable container port exposure through firewall, configure IP forwarding for VPN routing, and streamline installer for container-based architecture.
Output: UFW firewall rules for container ports, IP forwarding enabled, UFW forward policy configured, v1.0 idempotency checks removed from install.sh.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-docker-prerequisites-host-setup/DISCOVERY.md
@.planning/phases/05-docker-prerequisites-host-setup/05-CONTEXT.md
@.planning/phases/05-docker-prerequisites-host-setup/05-01-SUMMARY.md
@install.sh

**Phase 5 Context Summary:**
- **Goal:** Prepare host for containerized services with clean isolation
- **Key simplification:** Remove v1.0 idempotency complexity (container is clean slate)
- **Network requirements:** UDP 1194 (OpenVPN), TCP 443 (web portal)
- **User experience:** Transparent configuration, simple progress messages

**Discovery Findings - Network Configuration:**
- **Firewall:** UFW rules for Docker-exposed ports (Docker bypasses UFW by default, but our ports are intentionally exposed)
- **Port mapping:** UDP 1194 for OpenVPN, TCP 443 for web portal
- **IP forwarding:** Required for VPN routing, set `net.ipv4.ip_forward=1` in /etc/sysctl.conf
- **UFW forward policy:** Set to ACCEPT in /etc/default/ufw for container traffic
- **Bridge networking:** Use bridge mode (not host mode) for clean isolation per context

**v1.0 Idempotency to Remove:**
- Complex checks for existing OpenVPN installation on host
- Certificate/config file existence checks
- Service state checks for host-based OpenVPN
- All replaced by simple: "Does container exist?" check (Phase 6)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure UFW firewall rules for container ports</name>
  <files>install.sh</files>
  <action>
Add firewall configuration to install.sh after Docker/TUN verification:

1. **Check if UFW is installed and active:**
   - Check: `command -v ufw &>/dev/null`
   - Check active: `ufw status | grep -q "Status: active"`
   - If UFW not installed: Skip firewall configuration (some minimal VPS don't include UFW)
   - If installed but inactive: Display warning but don't enable automatically (user may have iptables config)

2. **Add UFW rules for container ports:**
   - OpenVPN: `ufw allow 1194/udp comment 'OpenVPN container'`
   - Web portal: `ufw allow 443/tcp comment 'Web portal container'`
   - Check if rules already exist before adding (idempotency)
   - Display: "Configuring firewall rules for container ports..."

3. **Reload UFW:**
   - Run: `ufw --force enable` (if not already active and user confirmed)
   - Run: `ufw reload` (if already active)
   - Display: "Firewall rules configured"

4. **What to avoid:**
   - Don't use DOCKER-USER chain method (complex, DISCOVERY.md recommends simple UFW rules for our use case)
   - Don't install ufw-docker tool (unnecessary complexity per DISCOVERY.md Solution 3)
   - Don't fail if UFW not present (not all VPS include UFW, iptables may be used instead)
   - Don't automatically enable UFW if disabled (user may be using custom iptables rules)

**UFW configuration pattern from DISCOVERY.md:**
```bash
if command -v ufw &>/dev/null; then
    echo "Configuring firewall rules for container ports..."
    ufw allow 1194/udp comment 'OpenVPN container' 2>/dev/null || true
    ufw allow 443/tcp comment 'Web portal container' 2>/dev/null || true

    if ufw status | grep -q "Status: active"; then
        ufw reload
        echo "Firewall rules configured"
    else
        echo "UFW installed but inactive. Please enable UFW manually: ufw enable"
    fi
fi
```
  </action>
  <verify>
- If UFW installed: `ufw status | grep 1194/udp` shows rule present
- If UFW installed: `ufw status | grep 443/tcp` shows rule present
- Script runs idempotently (re-running doesn't duplicate rules)
- No errors if UFW not installed (graceful fallback)
  </verify>
  <done>
UFW firewall rules configured for OpenVPN (UDP 1194) and web portal (TCP 443), or gracefully skipped if UFW not present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable IP forwarding and configure UFW forward policy</name>
  <files>install.sh</files>
  <action>
Add IP forwarding and UFW forward policy configuration to install.sh after firewall rules:

1. **Enable IP forwarding (required for VPN routing):**
   - Check current state: `sysctl net.ipv4.ip_forward`
   - If not enabled: `sysctl -w net.ipv4.ip_forward=1`
   - Persist on boot: Add/update `net.ipv4.ip_forward=1` in /etc/sysctl.conf
   - Check if line already exists before adding (idempotency)
   - Display: "Enabling IP forwarding..."

2. **Configure UFW forward policy to ACCEPT:**
   - Check if UFW config exists: `/etc/default/ufw`
   - If exists: Update `DEFAULT_FORWARD_POLICY="ACCEPT"` (replace existing DROP policy)
   - Use sed: `sed -i 's/DEFAULT_FORWARD_POLICY="DROP"/DEFAULT_FORWARD_POLICY="ACCEPT"/' /etc/default/ufw`
   - Reload UFW if active: `ufw reload`
   - Display: "UFW forward policy configured for container traffic"

3. **Why this is needed (from DISCOVERY.md):**
   - IP forwarding allows VPN clients to route traffic through server
   - UFW forward policy ACCEPT allows container-to-container and container-to-host traffic
   - Required for bridge networking mode (our choice per DISCOVERY.md)

4. **What to avoid:**
   - Don't skip IP forwarding (VPN won't route traffic without it)
   - Don't modify UFW policy if /etc/default/ufw doesn't exist (UFW not installed)
   - Don't fail if UFW config changes fail (some systems use iptables directly)

**IP forwarding pattern from DISCOVERY.md:**
```bash
echo "Enabling IP forwarding..."
sysctl -w net.ipv4.ip_forward=1

# Persist on boot
if ! grep -q "^net.ipv4.ip_forward=1" /etc/sysctl.conf; then
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
fi

# Configure UFW forward policy if UFW present
if [[ -f /etc/default/ufw ]]; then
    echo "Configuring UFW forward policy for container traffic..."
    sed -i 's/DEFAULT_FORWARD_POLICY="DROP"/DEFAULT_FORWARD_POLICY="ACCEPT"/' /etc/default/ufw

    if ufw status | grep -q "Status: active"; then
        ufw reload
    fi
fi
```
  </action>
  <verify>
- `sysctl net.ipv4.ip_forward` returns 1
- `grep "net.ipv4.ip_forward=1" /etc/sysctl.conf` finds entry
- If UFW present: `grep 'DEFAULT_FORWARD_POLICY="ACCEPT"' /etc/default/ufw` finds updated policy
- Script runs idempotently (re-running doesn't duplicate entries)
  </verify>
  <done>
IP forwarding enabled and persisted to /etc/sysctl.conf. UFW forward policy set to ACCEPT for container traffic (if UFW present).
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove v1.0 host-based idempotency checks</name>
  <files>install.sh</files>
  <action>
Simplify install.sh by removing v1.0 host-based OpenVPN idempotency logic that's no longer needed for container-based architecture:

1. **Identify and remove:**
   - Check for existing OpenVPN service on host: `systemctl is-active openvpn-server@server`
   - IS_UPDATE variable and logic (around line 95-100 based on file examination)
   - Messages about "Detected existing OpenVPN installation" and idempotent behavior
   - Host-based certificate/config existence checks
   - PKI directory state validation for host installation

2. **Replace with simplified detection:**
   - Add comment: "# Container-based installation - container provides clean slate"
   - Remove complex idempotency messages
   - Keep only: OS detection, root check, Docker installation (from 05-01)
   - Container existence check will be added in Phase 6 (not this phase per context boundaries)

3. **What to preserve:**
   - OS detection and validation (Ubuntu/Debian check)
   - Root privilege check
   - Error handling functions (error_exit, cleanup)
   - Variable declarations for paths (may be used in Phase 6)

4. **What to remove (per CONTEXT.md):**
   - "Complex idempotency checks from v1.0 (checking if OpenVPN is installed, if configs exist, etc.) should be carefully removed since the container handles this"
   - Existing service detection
   - IS_UPDATE logic branching
   - Messages about preserving existing clients/certificates (N/A for containers)

5. **Key insight from CONTEXT.md:**
   - "Instead of carefully checking host state and doing idempotent installations, the installer now: 1. Ensures Docker prerequisites exist, 2. Creates/recreates a container (the container is always fresh), 3. Lets the container handle the OpenVPN setup"

**Sections to remove:**
```bash
# Around line 90-110: Remove IS_UPDATE detection
if systemctl is-active --quiet openvpn-server@server 2>/dev/null; then
    echo "Detected existing OpenVPN installation"
    # ... entire block
    IS_UPDATE=true
else
    # ...
    IS_UPDATE=false
fi
```

Replace with simple comment noting container-based approach.
  </action>
  <verify>
- `grep -i "IS_UPDATE" install.sh` returns no matches
- `grep -i "existing OpenVPN installation" install.sh` returns no matches
- `grep "systemctl is-active.*openvpn-server@server" install.sh` returns no matches
- Script still has: root check, OS detection, error functions
- Script syntax valid: `bash -n install.sh` succeeds
  </verify>
  <done>
v1.0 host-based idempotency logic removed from install.sh. Installer simplified for container-based architecture where container provides clean slate.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n install.sh` passes (syntax check)
- [ ] `sysctl net.ipv4.ip_forward` shows 1
- [ ] If UFW present: `ufw status | grep 1194/udp` shows OpenVPN rule
- [ ] If UFW present: `ufw status | grep 443/tcp` shows web portal rule
- [ ] If UFW present: `grep 'DEFAULT_FORWARD_POLICY="ACCEPT"' /etc/default/ufw` succeeds
- [ ] `grep "IS_UPDATE" install.sh` returns nothing (removed)
- [ ] `grep "net.ipv4.ip_forward=1" /etc/sysctl.conf` finds entry
- [ ] Script runs idempotently (no duplicate sysctl entries or UFW rules)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- UFW firewall configured for container ports (or gracefully skipped if UFW absent)
- IP forwarding enabled and persisted
- UFW forward policy set to ACCEPT (if UFW present)
- v1.0 host-based idempotency logic removed
- Installer simplified for container-based architecture
- No syntax errors in install.sh
- Phase 5 complete - host ready for Phase 6 containerization
</success_criteria>

<output>
After completion, create `.planning/phases/05-docker-prerequisites-host-setup/05-02-SUMMARY.md`:

# Phase 5 Plan 2: Host Network Configuration Summary

**Host networking configured for containers, installer simplified for container-based architecture**

## Accomplishments

- UFW firewall rules configured for OpenVPN (UDP 1194) and web portal (TCP 443)
- IP forwarding enabled and persisted to /etc/sysctl.conf for VPN routing
- UFW forward policy set to ACCEPT for container traffic
- v1.0 host-based idempotency logic removed from install.sh
- Installer simplified - container provides clean slate (no complex host state checks)

## Files Created/Modified

- `install.sh` - Added UFW rules, IP forwarding, UFW forward policy configuration; removed v1.0 IS_UPDATE logic and host-based OpenVPN checks
- `/etc/sysctl.conf` - IP forwarding persistence (net.ipv4.ip_forward=1)
- `/etc/default/ufw` - Forward policy updated to ACCEPT (if UFW present)

## Decisions Made

- Used simple UFW allow rules (not DOCKER-USER chain or ufw-docker tool) per DISCOVERY.md recommendation for intentionally exposed ports
- Graceful fallback if UFW not installed (some VPS use iptables directly)
- Removed all v1.0 idempotency complexity per CONTEXT.md - container is clean slate

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 5 complete! Ready for Phase 6 (Containerized OpenVPN & Portal) - create Dockerfile, docker-compose.yml, and containerize services.
</output>
